<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>空と雲と夕焼けの色シミュレーション</title>
</head>
<body>
<h2>散乱と空・雲・夕焼けの色</h2>

<label>粒径 (nm): 
  <input type="range" id="size" min="10" max="1000" value="50" step="10">
</label>
<span id="sizeVal">50</span> nm<br>

<label>光路長 (相対値): 
  <input type="range" id="path" min="1" max="10" value="1" step="1">
</label>
<span id="pathVal">1</span><br><br>

<div>
  <canvas id="colorBox" width="200" height="100" style="border:1px solid black;"></canvas>
</div>
<div>
  <canvas id="spectrum" width="400" height="200" style="border:1px solid black;"></canvas>
</div>

<script>
// 可視光波長
const wavelengths = Array.from({length:81}, (_,i)=>380+i*5); // 380–780 nm

const ctxBox = document.getElementById("colorBox").getContext("2d");
const ctxSpec = document.getElementById("spectrum").getContext("2d");

// 散乱強度の簡易モデル
function scattering(lambda, size){
  // 小さい粒径では ~1/λ^4、大きい粒径ではほぼ一定
  const factor = 1/(1+(lambda/size)**4);
  return factor;
}

// 光路長による減衰
function transmission(lambda, path){
  // 短波長ほど減衰が大きい → exp(-k/λ^4 * path)
  const k = 5e9; 
  return Math.exp(-k/(lambda**4) * path);
}

// 波長→RGB変換
function wavelengthToRGB(wl) {
  let r=0,g=0,b=0;
  if (wl>=380 && wl<440){ r=-(wl-440)/(60); g=0; b=1;}
  else if (wl<490){ r=0; g=(wl-440)/50; b=1;}
  else if (wl<510){ r=0; g=1; b=-(wl-510)/20;}
  else if (wl<580){ r=(wl-510)/70; g=1; b=0;}
  else if (wl<645){ r=1; g=-(wl-645)/65; b=0;}
  else if (wl<=780){ r=1; g=0; b=0;}
  return [r,g,b];
}

function update(){
  const size = parseInt(document.getElementById("size").value);
  const path = parseInt(document.getElementById("path").value);
  document.getElementById("sizeVal").textContent = size;
  document.getElementById("pathVal").textContent = path;

  let spectrum = [];
  wavelengths.forEach(wl=>{
    let I = scattering(wl, size) * transmission(wl, path);
    spectrum.push(I);
  });

  // 色合成
  let rgb = [0,0,0];
  wavelengths.forEach((wl,i)=>{
    let [r,g,b] = wavelengthToRGB(wl);
    rgb[0]+=r*spectrum[i];
    rgb[1]+=g*spectrum[i];
    rgb[2]+=b*spectrum[i];
  });
  const max = Math.max(...rgb);
  rgb = rgb.map(v=>Math.min(255, (v/max)*255));

  // 色を表示
  ctxBox.fillStyle = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
  ctxBox.fillRect(0,0,200,100);

  // スペクトル表示
  ctxSpec.clearRect(0,0,400,200);
  ctxSpec.beginPath();
  ctxSpec.moveTo(0,200-spectrum[0]*180);
  spectrum.forEach((val,i)=>{
    ctxSpec.lineTo(i*(400/spectrum.length),200-val*180);
  });
  ctxSpec.stroke();
}

document.getElementById("size").addEventListener("input", update);
document.getElementById("path").addEventListener("input", update);
update();
</script>
</body>
</html>
