<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>光散乱グラデーション</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    .controls { margin: 20px; }
    canvas { border: 2px solid #333; margin-top: 20px; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>光散乱グラデーション</h1>

  <div class="controls">
    <label>
      粒径（nm）: <span id="sizeValue">50</span>
      <input type="range" id="sizeSlider" min="10" max="1000" value="50">
    </label>

    <label>
      光の到達距離（容器の高さ）: <span id="distanceValue">200</span>
      <input type="range" id="distanceSlider" min="50" max="500" value="200">
    </label>
  </div>

  <canvas id="gradientCanvas" width="300" height="200"></canvas>

  <script>
    const sizeSlider = document.getElementById("sizeSlider");
    const distanceSlider = document.getElementById("distanceSlider");
    const sizeValue = document.getElementById("sizeValue");
    const distanceValue = document.getElementById("distanceValue");
    const canvas = document.getElementById("gradientCanvas");
    const ctx = canvas.getContext("2d");

    function wavelengthToRGB(wavelength) {
      let R = 0, G = 0, B = 0;
      if (wavelength >= 380 && wavelength < 440) {
        R = -(wavelength - 440) / (440 - 380);
        B = 1;
      } else if (wavelength < 490) {
        G = (wavelength - 440) / (490 - 440);
        B = 1;
      } else if (wavelength < 510) {
        G = 1;
        B = -(wavelength - 510) / (510 - 490);
      } else if (wavelength < 580) {
        R = (wavelength - 510) / (580 - 510);
        G = 1;
      } else if (wavelength < 645) {
        R = 1;
        G = -(wavelength - 645) / (645 - 580);
      } else if (wavelength <= 780) {
        R = 1;
      }
      return [R, G, B];
    }

    function getScatteredColor(size, distanceFraction) {
      let totalRGB = [0, 0, 0];
      for (let wl = 380; wl <= 780; wl += 5) {
        let intensity = size < 200 ? 1 / Math.pow(wl, 4) : 1;
        intensity *= Math.exp(-distanceFraction * 2); // 距離による減衰
        const [r, g, b] = wavelengthToRGB(wl);
        totalRGB[0] += r * intensity;
        totalRGB[1] += g * intensity;
        totalRGB[2] += b * intensity;
      }
      const max = Math.max(...totalRGB);
      return totalRGB.map(c => Math.min(255, Math.floor((c / max) * 255)));
    }

    function drawGradient() {
      const size = parseFloat(sizeSlider.value);
      const distance = parseFloat(distanceSlider.value);
      sizeValue.textContent = size;
      distanceValue.textContent = distance;

      const height = canvas.height;
      for (let y = 0; y < height; y++) {
        const fraction = y / height;
        const rgb = getScatteredColor(size, fraction * distance / 200);
        ctx.fillStyle = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
        ctx.fillRect(0, y, canvas.width, 1);
      }
    }

    sizeSlider.addEventListener("input", drawGradient);
    distanceSlider.addEventListener("input", drawGradient);

    drawGradient(); // 初期表示
  </script>
</body>
</html>
